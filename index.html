<html>
  <head>
      <script src='/_ah/channel/jsapi'></script>
      <style type='text/css'>
        body {
          font-family: 'Helvetica';
        }

        #board {
          width:152px;
          height: 152px;
          margin: 20px auto;
        }
        .border-class {
            border-right: 2px solid #000000;
        }
        #display-area {
          text-align: center;
        }
       
        #this-game {
          font-size: 9pt;
        }

        #winner {
        }
       
        table {
          border-collapse: collapse;
        }
       
        td {
          width: 50px;
          height: 50px;
          font-family: "Helvetica";
          font-size: 16pt;
          text-align: center;
          vertical-align: middle;
          margin:0px;
          padding: 0px;
        }
       
        div.cell {
          float: left;
          width: 50px;
          height: 50px;
          border: none;
          margin: 0px;
          padding: 0px;
        }
       
        div.mark {
          position: absolute;
          top: 15px;          
        }
       
        div.l {
          border-right: 1pt solid black;
        }
       
        div.c {
        }
       
        div.r {
          border-left: 1pt solid black;
        }
       
        div.t {
          border-bottom: 1pt solid black;
        }
       
        div.m {
        }
       
        div.b {
          border-top: 1pt solid black;
        }

          .cell-padding{
              padding-right: 20px;
              padding-left: 20px;
          }
      </style>
      <title>
          Advanced Tic Tac Toe
      </title>
  </head>
  <body>

    <div id='display-area' align="center">
      <h2>Advanced Tic Tac Toe</h2>
      <div id='other-player' style='display:none'>
        Waiting for another player to join.<br>
        <!--
        Send them this link to play:<br>
        <div id='game-link'><a href='Game_link}}'>Game_link}]</a></div>
        -->
      </div>
      <div id='your-move' style='display:none'>
        Your move! Click a square to place your piece.
      </div>
      <div id='their-move' style='display:none'>
        Waiting for other player to move...
      </div>
      <div id='you-won' style="font-family: Arial; color: forestgreen;">
        You won this game! :)
      </div>
      <div id='you-lost' style="font-family: Arial; color: red;">
        You lost this game! :(
      </div>

       <div align="center" id="BADA">
        <table>
            <tr style="border-bottom: 2px solid black;">
                <td class="border-class cell-padding">
                   <div id="bimg0"></div>
                    <div id="board0">
                        <div id='board'>
                        <div class='t l cell'><table><tr><td id='0'></td></tr></table></div>
                        <div class='t c cell'><table><tr><td id='1'></td></tr></table></div>
                        <div class='t r cell'><table><tr><td id='2'></td></tr></table></div>
                        <div class='m l cell'><table><tr><td id='3'></td></tr></table></div>
                        <div class='m c cell'><table><tr><td id='4'></td></tr></table></div>
                        <div class='m r cell'><table><tr><td id='5'></td></tr></table></div>
                        <div class='b l cell'><table><tr><td id='6'></td></tr></table></div>
                        <div class='b c cell'><table><tr><td id='7'></td></tr></table></div>
                        <div class='b r cell'><table><tr><td id='8'></td></tr></table></div>
                        </div>
                    </div>
                </td>

                <td class="border-class cell-padding">
                   <div id="bimg1"></div>
                    <div id="board1">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='9'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='10'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='11'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='12'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='13'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='14'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='15'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='16'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='17'></td></tr></table></div>
                    </div>
                   </div>
                </td>

                <td class="cell-padding">
                   <div id="bimg2"></div>
                   <div id="board2">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='18'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='19'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='20'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='21'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='22'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='23'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='24'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='25'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='26'></td></tr></table></div>
                    </div>
                   </div>
                </td>
            </tr>

            <tr style="border-bottom: 2px solid black;">
                <td class="border-class cell-padding">
                   <div id="bimg3"></div>
                    <div id="board3">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='27'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='28'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='29'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='30'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='31'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='32'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='33'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='34'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='35'></td></tr></table></div>
                    </div>
                   </div>
                </td>

                <td class="border-class cell-padding">
                   <div id="bimg4"></div>
                    <div id="board4">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='36'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='37'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='38'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='39'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='40'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='41'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='42'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='43'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='44'></td></tr></table></div>
                    </div>
                   </div>
                </td>

                <td class="cell-padding">
                   <div id="bimg5"></div>
                    <div id="board5">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='45'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='46'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='47'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='48'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='49'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='50'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='51'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='52'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='53'></td></tr></table></div>
                    </div>
                   </div>
                </td>
            </tr>

            <tr>
                <td class="border-class cell-padding">
                  <div id="bimg6"></div>
                    <div id="board6">
                   <div id='board'>
                    <div class='t l cell'><table><tr><td id='54'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='55'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='56'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='57'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='58'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='59'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='60'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='61'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='62'></td></tr></table></div>
                    </div>
                   </div>
                </td>

                <td class="border-class cell-padding">
                   <div id="bimg7"></div>
                    <div id="board7">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='63'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='64'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='65'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='66'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='67'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='68'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='69'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='70'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='71'></td></tr></table></div>
                    </div>
                   </div>
                </td>

                <td class="cell-padding">
                   <div id="bimg8"></div>
                    <div id="board8">
                    <div id='board'>
                    <div class='t l cell'><table><tr><td id='72'></td></tr></table></div>
                    <div class='t c cell'><table><tr><td id='73'></td></tr></table></div>
                    <div class='t r cell'><table><tr><td id='74'></td></tr></table></div>
                    <div class='m l cell'><table><tr><td id='75'></td></tr></table></div>
                    <div class='m c cell'><table><tr><td id='76'></td></tr></table></div>
                    <div class='m r cell'><table><tr><td id='77'></td></tr></table></div>
                    <div class='b l cell'><table><tr><td id='78'></td></tr></table></div>
                    <div class='b c cell'><table><tr><td id='79'></td></tr></table></div>
                    <div class='b r cell'><table><tr><td id='80'></td></tr></table></div>
                    </div>
                   </div>
                </td>
            </tr>
        </table>
        </div>

      <!-- div id='this-game' float='top'>
        Quick link to this game: <span id='this-game-link'><a href='Game_link'>Game_link</a></span>
      </div -->

    </div>
  <script type='text/javascript'>
      var state = {
        game_key: '{{ game_key }}',
        me: '{{ me }}'
      };

      updateGame = function() {
          for (i = 0; i < 81; i++) {
              var square = document.getElementById(i);
              square.innerHTML = state.board[i];
          }

          if(state.bigWin != '') {
              for(i = 0; i< 9;i++){
                  if(state.bigWin[i] == 'X'){
                     document.getElementById('board'+ i.toString()).style.display='none';
                     document.getElementById('bimg'+ i.toString()).innerHTML='<img height="100px" width="100px" src="/static/images/x.jpg" />';
                  }
                  else if(state.bigWin[i]=='O'){
                      document.getElementById('board'+ i.toString()).style.display='none';
                      document.getElementById('bimg'+ i.toString()).innerHTML='<img height="100px" width="100px" src="/static/images/o.png" />';
                  }
              }
          }

          if (state.winner != '' && state.winningBoard != '') {
              /*  if (state.winningBoard[i] == state.board[i]) {
                  if (state.winner == state.me) {
                    square.style.background = "green";
                  } else {
                    square.style.background = "red";
                  }
                } else {
                  square.style.background = "white";
                }*/


           }


        var display = {
          'other-player': 'none',
          'your-move': 'none',
          'their-move': 'none',
          'you-won': 'none',
          'you-lost': 'none',
          'BADA': 'block'
          // 'this-game': 'block'
        };

        if (!state.userO || state.userO == '') {
          display['other-player'] = 'block';
          display['BADA'] = 'none';

          // display['this-game'] = 'none';
        } else if (state.winner == state.me) {
          display['you-won'] = 'block';
        } else if (state.winner != '') {
          display['you-lost'] = 'block';
        } else if (isMyMove()) {
          display['your-move'] = 'block';
        } else {
          display['their-move'] = 'block';
        }

        for (var label in display) {
          document.getElementById(label).style.display = display[label];
        }
      };

      isMyMove = function() {
        return (state.winner == "") &&
            (state.moveX == (state.userX == state.me));
      }

      myPiece = function() {
        return state.userX == state.me ? 'X' : 'O';
      }

      sendMessage = function(path, opt_param) {
        path += '?g=' + state.game_key;
        if (opt_param) {
          path += '&' + opt_param;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', path, true);
        xhr.send();
      };

      moveInSquare = function(id) {
        if (isMyMove() && state.board[id] == ' ') {
          sendMessage('/move', 'i=' + id);
        }
      }

      highlightSquare = function(id) {
        if (state.winner != "") {
          return;
        }

        for (i = 0; i < 81; i++) {
          if (i == id  && isMyMove()) {
            if (state.board[i] = ' ') {
              color = 'lightBlue';
            } else {
              color = 'lightGrey';
            }
          } else {
            color = 'white';
          }

          document.getElementById(i).style['background'] = color;
        }

      }

      onOpened = function() {
        sendMessage('/opened');
      };

      onMessage = function(m) {
        newState = JSON.parse(m.data);
        state.board = newState.board || state.board;
        state.userX = newState.userX || state.userX;
        state.userO = newState.userO || state.userO;
        state.moveX = newState.moveX;
        state.bigWin = newState.bigWin;
        state.winner = newState.winner || "";
        state.winningBoard = newState.winningBoard || "";
        updateGame();
      }

      openChannel = function() {
        var token = '{{ token }}';
        var channel = new goog.appengine.Channel(token);
        var handler = {
          'onopen': onOpened,
          'onmessage': onMessage,
          'onerror': function() {},
          'onclose': function() {}
        };
        var socket = channel.open(handler);
        socket.onopen = onOpened;
        socket.onmessage = onMessage;
      }

      initialize = function() {
        openChannel();
        var i;
        for (i = 0; i < 81; i++) {
          var square = document.getElementById(i);
          square.onmouseover = new Function('highlightSquare(' + i + ')');
          square.onclick = new Function('moveInSquare(' + i + ')');
        }
        onMessage({data: '{{ initial_message }}'});
      }

      setTimeout(initialize, 100);

    </script>


  </body>
</html>